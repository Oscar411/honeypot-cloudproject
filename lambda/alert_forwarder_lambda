import json
import os
from datetime import datetime

import boto3

s3 = boto3.client("s3")

BUCKET_NAME = os.environ.get("EVIDENCE_BUCKET", "")

def lambda_handler(event, context):
    """
    simple behavior:
    - gets the full event from EventBridge (GuardDuty finding)
    - writes it to S3 as a json file
    """

    if not BUCKET_NAME:
        raise RuntimeError("EVIDENCE_BUCKET env var not set")
    
    timestamp = datetime.utcnow().strftime("%Y-%m-%dT%H-%M-%SZ")
    key = f"gaurdduty/findings/{timestamp}.json"

    body = json.dumps(event, default=str).encode("utf-8")

    s3.put_object(
        Bucket=BUCKET_NAME,
        Key=key,
        Body=body,
        COntentTpe="application/json",
    )

    return {
        "status": "ok"
        "bucket": BUCKET_NAME,
        "key" : key,
    }